<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapporti Indagini - Sala Indagini</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <div class="min-h-screen p-8">
        <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold">Dashboard Rapporti Indagini</h1>
                <div>
                    <button onclick="window.location.href='sala_indagini.html'" class="bg-gray-500 text-white px-4 py-2 rounded">Torna Indietro</button>
                </div>
            </div>

            <div class="mb-6 flex gap-4">
                <select id="sheetFilter" class="border rounded p-2">
                    <option value="Rapporti indagine">Rapporti Indagine</option>
                </select>
                <input type="text" id="searchFilter" placeholder="Cerca..." class="border rounded p-2 w-1/3">
                <button onclick="applyFilters()" class="bg-blue-500 text-white px-4 py-2 rounded">Applica Filtri</button>
            </div>

            <div id="tabsContainer" class="mb-4"></div>

            <div id="dataContainer" class="bg-white rounded-lg shadow overflow-x-auto">
                <!-- Table will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        let allData = {};
        let currentSection = null;
        
        async function loadSheetData() {
            const sheet = document.getElementById('sheetFilter').value;
            const response = await fetch(`https://script.google.com/macros/s/AKfycbw1vjQcIqyEWb0XhwO_-Cjs8cnKpNPsCr6pu8DCWpD1iiIBhLz_Dj81DPWwJJwuZDHnjQ/exec`);
            allData = await response.json();
            displayTabs(allData[sheet]);
            displayData(sheet, allData[sheet][0]); // Display first section by default
        }

        function displayTabs(data) {
            const tabsContainer = document.getElementById('tabsContainer');
            tabsContainer.innerHTML = '';
            
            data.forEach((section, index) => {
                const tabButton = document.createElement('button');
                tabButton.textContent = section.title;
                tabButton.className = 'px-4 py-2 rounded-t-lg ' + (index === 0 ? 'bg-white text-blue-600' : 'bg-gray-200 text-gray-700');
                tabButton.onclick = () => {
                    displayData('Rapporti indagine', section);
                    setActiveTab(tabButton);
                };
                tabsContainer.appendChild(tabButton);
            });
        }

        function setActiveTab(activeTab) {
            const tabs = document.getElementById('tabsContainer').children;
            for (let tab of tabs) {
                tab.className = 'px-4 py-2 rounded-t-lg bg-gray-200 text-gray-700';
            }
            activeTab.className = 'px-4 py-2 rounded-t-lg bg-white text-blue-600';
        }

        function displayData(sheet, section) {
            const dataContainer = document.getElementById('dataContainer');
            dataContainer.innerHTML = '';

            if (!section || !section.rows || section.rows.length === 0) {
                dataContainer.innerHTML = '<p class="px-6 py-4 text-center">Nessun dato disponibile</p>';
                return;
            }
            
            const table = document.createElement('table');
            table.className = 'min-w-full';
            
            // Create table header
            const thead = document.createElement('thead');
            thead.className = 'bg-gray-50';
            const headerRow = document.createElement('tr');
            
            // Get all unique keys from the first row
            const allKeys = Object.keys(section.rows[0]).filter(key => 
                key !== '_sheetName' && key !== '_rowIndex' && key !== '_section' && key.toString().trim() !== ''
            );
            
            allKeys.forEach(key => {
                const th = document.createElement('th');
                th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase';
                th.textContent = key;
                headerRow.appendChild(th);
            });
            
            // Add "Actions" header
            const actionsHeader = document.createElement('th');
            actionsHeader.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase';
            actionsHeader.textContent = 'Azioni';
            headerRow.appendChild(actionsHeader);
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create table body
            const tbody = document.createElement('tbody');
            tbody.className = 'bg-white divide-y divide-gray-200';
            
            section.rows.forEach(row => {
                const tr = document.createElement('tr');
                
                allKeys.forEach(key => {
                    const td = document.createElement('td');
                    td.className = 'px-6 py-4';
                    td.textContent = row[key] || '';
                    tr.appendChild(td);
                });
                
                // Add delete button
                const actionsTd = document.createElement('td');
                actionsTd.className = 'px-6 py-4';
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Elimina';
                deleteButton.className = 'text-red-600 hover:text-red-900 ml-2';
                deleteButton.onclick = () => deleteReport(sheet, row._rowIndex);
                actionsTd.appendChild(deleteButton);
                tr.appendChild(actionsTd);
                
                tbody.appendChild(tr);
            });
            
            table.appendChild(tbody);
            dataContainer.appendChild(table);
        }

        async function deleteReport(sheet, rowIndex) {
            if (confirm('Sei sicuro di voler eliminare questo record?')) {
                await fetch('https://script.google.com/macros/s/AKfycbw1vjQcIqyEWb0XhwO_-Cjs8cnKpNPsCr6pu8DCWpD1iiIBhLz_Dj81DPWwJJwuZDHnjQ/exec', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'delete', sheetName: sheet, rowIndex })
                });
                loadSheetData();
            }
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
            const filteredData = allData['Rapporti indagine'].map(section => ({
                ...section,
                rows: section.rows.filter(row => 
                    Object.values(row).some(value => 
                        value && 
                        typeof value === 'string' && 
                        value.toLowerCase().includes(searchTerm)
                    )
                )
            })).filter(section => section.rows.length > 0);

            displayTabs(filteredData);
            if (filteredData.length > 0) {
                displayData('Rapporti indagine', filteredData[0]);
            } else {
                document.getElementById('dataContainer').innerHTML = '<p class="px-6 py-4 text-center">Nessun risultato trovato</p>';
            }
        }
        
        document.getElementById('sheetFilter').addEventListener('change', loadSheetData);
        document.getElementById('searchFilter').addEventListener('input', applyFilters);
        document.addEventListener('DOMContentLoaded', loadSheetData);
    </script>
</body>
</html>

